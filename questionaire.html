<!DOCTYPE html>
<html>
<head>
  <title>Questionnaire</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl text-center">Questionnaire</h1>
    <p class="text-gray-700 p-4 mb-4 text-center">Please take a moment to answer a few questions in order for us to provide you with the best possible experience.</p>
    <form id="questionnaire-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
      <div class="mb-4">
        <label id="question1" for="question1" class="font-bold mb-2">Question 1:</label>
        <select id="answer1" name="answer1" class="block w-full p-2 border border-gray-300 rounded-md">
          <option value="option1">Option 1</option>
          <option value="option2">Option 2</option>
          <option value="option3">Option 3</option>
        </select>
      </div>

      <div class="mb-4">
        <label id="question2" for="question2" class="font-bold mb-2">Question 2:</label>
        <select id="answer2" name="answer2" class="block w-full p-2 border border-gray-300 rounded-md">
          <option value="option1">Option 1</option>
          <option value="option2">Option 2</option>
          <option value="option3">Option 3</option>
        </select>
      </div>

      <div class="mb-4">
        <label id="question3" for="question3" class="font-bold mb-2">Question 3:</label>
        <select id="answer3" name="answer3" class="block w-full p-2 border border-gray-300 rounded-md">
          <option value="option1">Option 1</option>
          <option value="option2">Option 2</option>
          <option value="option3">Option 3</option>
        </select>
      </div>

      <div class="mb-4">
        <label id="question4" for="question4" class="font-bold mb-2">Question 4:</label>
        <select id="answer4" name="answer4" class="block w-full p-2 border border-gray-300 rounded-md">
          <option value="option1">Option 1</option>
          <option value="option2">Option 2</option>
          <option value="option3">Option 3</option>
        </select>
      </div>

      <div class="mb-4">
        <label id="question5" for="question5" class="font-bold mb-2">Question 5:</label>
        <input type="text" id="answer5" name="answer5" class="block w-full p-2 border border-gray-300 rounded-md" required>
      </div>

      <button type="button" id="submit-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded">Submit</button>
    </form>
  </div>

  <script>
    // Assuming you have a form with the id 'answersForm' and a submit button with the id 'submitButton'

    // Event listener for form submission
    document.getElementById('answersForm').addEventListener('submit', (event) => {
      event.preventDefault(); // Prevent the form from submitting normally

      // Get the form data
      const formData = new FormData(event.target);

      // Convert form data to JSON object
      const answers = Array.from(formData.entries()).reduce((acc, [key, value]) => {
        const [prefix, questionId, answerType] = key.split('-');

        if (!acc[questionId]) {
          acc[questionId] = {
            question_id: parseInt(questionId),
            answer_type: parseInt(answerType),
          };
        }

        if (answerType === '1') {
          acc[questionId].option_id = parseInt(value);
        } else if (answerType === '2') {
          acc[questionId].content = value;
        }

        return acc;
      }, {});

      const requestData = {
        answers: Object.values(answers),
      };

    function getCookieValue(name) {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.startsWith(name + '=')) {
                  return cookie.substring(name.length + 1);
              }
          }
          return null;
      }

      // Get the API bearer token from the cookie
      const accessToken = getCookieValue('access_token');

      // Send the data to the server
      fetch('https://kevlongalloway.shop/api/v1/answers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + accessToken
        },
        body: JSON.stringify(requestData),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log(data); // Handle the response from the server
          // Redirect or perform any other actions as needed
        })
        .catch((error) => {
          console.error(error); // Handle any errors that occurred during the request
          // Display an error message or perform error handling
        });
    });

  </script>
  <script>
        // Make an AJAX request to retrieve questions
    function fetchQuestions() {
      return fetch('https://kevlongalloway.shop/api/questions')
        .then(response => response.json())
        .then(data => {
          populateQuestions(data);
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    // Populate the questions and options into the HTML form
    function populateQuestions(questions) {
      questions.forEach((question, index) => {
        const questionNumber = index + 1;
        const questionElement = document.getElementById(`question${questionNumber}`);
        const questionType = question.question_type;
        
        // Populate question and question type
        const labelElement = document.querySelector(`label[for="question${questionNumber}"]`);
        labelElement.textContent = `Question ${questionNumber}: ${question.question}`;
        questionElement.setAttribute('data-question-type', questionType);
        
        // Clear previous options (if any)
        questionElement.innerHTML = '';

        // Populate options if question type is multiple choice
        if (questionType === 1) {
          question.options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.id;
            optionElement.textContent = option.option;
            questionElement.appendChild(optionElement);
          });
        }
      });
    }

    // Event listener for submit button
    document.getElementById('submit-btn').addEventListener('click', function() {
      const form = document.getElementById('questionnaire-form');
      const formData = new FormData(form);

      // Get question types and store them in hidden inputs
      const questionInputs = form.querySelectorAll('select, input[type="text"]');
      questionInputs.forEach(input => {
        const questionType = input.getAttribute('data-question-type');
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `${input.id}_question_type`;
        hiddenInput.value = questionType;
        form.appendChild(hiddenInput);
      });

      // Submit the form
      // form.submit();
    });
    document.addEventListener('DOMContentLoaded', function() {
      fetchQuestions();
    });
  </script>
</body>
</html>
